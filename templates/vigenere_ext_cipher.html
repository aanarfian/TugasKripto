{% extends "base.html" %}

{% block title %}Extended Vigenere Cipher (256 karakter ASCII){% endblock %}

{% block content %}
  <div class="container py-5">
    <div class="row d-flex align-items-center" style="min-height: 60vh;">
      <div class="col">
        <h1 class="display-2 mb-5">Extended Vigenere Cipher (256 karakter ASCII)</h1>

        <!--
          ====================================================================
                                      ENKRIPSI
          ====================================================================
        -->

        <h1 class="display-4 mb-4">Enkripsi</h1>

        <!-- form text dan shift -->
        <form id="enc-form" action="/vigenere-ext-cipher?type=enc"
            method="POST" class="mb-2">

          <label class="form-label">Input</label>
          <span id="enc-input-data-err" class="d-none text-danger">
            &nbsp;<span></span>
          </span>

          <div class="mb-3 w-50">
            <select id="enc-input-type" class="form-select mb-3">
              <option value="text" selected>Teks</option>
              <option value="file">File</option>
            </select>

            <div id="enc-input-box"></div>
          </div>

          <div class="mb-3 w-50">
            <label class="form-label">Key</label>
            <span id="enc-input-key-err" class="d-none text-danger">
              &nbsp;<span></span>
            </span>

            <input id="enc-input-key" class="form-control" name="key" type="text"
                placeholder="e.g. SEBUAHKEY (tidak boleh ada karakter selain huruf alfabet)">
          </div>

          <input type="hidden" id="enc-real-content" name="data">

          <button type="submit" id="enc-input-submit" class="btn btn-primary">
            Submit
          </button>
        </form>

        <!-- hasil enkripsi -->
        <div class="mb-5 w-50">
          <label class="col-form-label">Hasil Enkripsi</label>

          <div id="enc-output-box" class="d-none">
            <p id="enc-output-text-result"><em></em></p>
            <p id="enc-output-file-result"><a>Download file</a></p>
          </div>
        </div>

        <template id="enc-template-input-textarea">
          <textarea class="enc-input-textarea form-control" placeholder="masukkan teks yang ingin dienkripsi"></textarea>
        </template>

        <template id="enc-template-input-file">
          <input class="enc-input-file" type="file">
        </template>

        <!--
          ====================================================================
                                      DEKRIPSI
          ====================================================================
        -->

        <h1 class="display-4">Dekripsi</h1>

        <!-- form text dan shift -->
        <form action="/Subtitution-Cipher-standard" method="POST"
            enctype="multipart/form-data" name="inputfile" class="mb-2">
          <div class="mb-3">
            <label class="form-label">Text</label>
            <input name="text_dec" type="text" placeholder="ALPHABET KAPITAL"
                pattern="[a-zA-Z]*" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Key</label>
            <input name="key_dec" type="text" pattern="[a-zA-Z]{26}"
                placeholder="PERMUTASI 26 HURUF ALPHABET KAPITAL"
                class="form-control" required>
          </div>
          <button type="submit" class="btn btn-primary">Submit</button>
        </form>

        <!-- hasil dekripsi -->
        <div class="mb-3">
          <label class="col-form-label">Hasil Dekripsi</label>
          <input type="text" class="form-control" id="Entropy" disabled>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block script %}
  <script>
    // Diletakkan di sini agar syntax highlighting di
    // tag <script> yang satunya tidak bermasalah :D.
    const serverOutput = {{ output|safe }};
  </script>

  <script>
    window.onload = function() {

      // Template untuk membuat tipe input/output dapat
      // dinamis dengan mudah.
      const TEMPLATES = {
        INPUT: {
          TEXTAREA: document.querySelector("#enc-template-input-textarea").innerHTML,
          FILE: document.querySelector("#enc-template-input-file").innerHTML,
        },
      };

      /**
       * Logika input.
       */
      (function () {
        let input;

        /**
         * Input handlers.
         */
        const inputHandlers = {
          text: function (event) {
            input = event.target.value;
          },

          file: function (event) {
            const reader = new FileReader();

            reader.addEventListener("load", function (event) {
              input = event.target.result;
            });

            reader.readAsText(event.target.files[0], "ASCII");
          },
        };

        /**
         * Handle perubahan tipe data input.
         */
        document.querySelector("#enc-input-type")
            .addEventListener("change", function () {
              const inputType = document.querySelector("#enc-input-type").value;
              const newInputEl = inputType == "text"
                  ? TEMPLATES.INPUT.TEXTAREA
                  : TEMPLATES.INPUT.FILE;

              document.querySelector("#enc-input-box").innerHTML = newInputEl;
              input = "";

              if (inputType === "file") {
                document.querySelector(".enc-input-file")
                    .addEventListener("change", inputHandlers.file);
              } else {
                document.querySelector(".enc-input-textarea")
                    .addEventListener("change", inputHandlers.text);
              }
            });

        /**
         * Validator untuk input-input.
         */
        const validators = {
          validateInputData: function () {
            if (!input) {
              document.querySelector("#enc-input-data-err")
                  .classList.remove("d-none");
              document.querySelector("#enc-input-data-err span")
                  .innerHTML = "* data tidak valid";

              return false;
            }

            document.querySelector("#enc-input-data-err")
                .classList.add("d-none");
            return true;
          },

          validateKey: function () {
            const key = document.querySelector("#enc-input-key").value ?? "";

            if (!key.match(/[A-Z]+/i)) {
              document.querySelector("#enc-input-key-err")
                  .classList.remove("d-none");
              document.querySelector("#enc-input-key-err span")
                  .innerHTML = "* key harus terdiri atas huruf alfabet";

              return false;
            }

            document.querySelector("#enc-input-key-err")
                .classList.add("d-none");
            return true;
          },
        };

        /**
         * Handle submit.
         */
        document.querySelector("#enc-form")
            .addEventListener("submit", function (event) {
              const isValidInputData = validators.validateInputData();
              const isValidKey = validators.validateKey();

              if (!isValidInputData || !isValidKey) {
                event.preventDefault();
              }

              document.querySelector("#enc-real-content").value = input;
            });

        // Trigger inisialisasi ketika page baru diload
        // pertama kali.
        document.querySelector("#enc-input-type")
            .dispatchEvent(new Event("change"));
      })();

      /**
       * Logika output
       */
      (function () {
        const output = serverOutput;

        const emptyOutput = output
            && Object.keys(output).length === 0
            && output.constructor === Object;

        if (emptyOutput) {
          return;
        }

        if (output.type === 'encryption') {
          const bytestring = output.result
            .map(b => `0x${b.toString(16)}`)
            .join(" ");

          document.querySelector("#enc-output-box").classList
              .remove("d-none");

          // tampilkan bytestring hasil enkripsi
          document.querySelector("#enc-output-text-result em")
              .innerHTML = bytestring;

          // file hasil enkripsi
          document.querySelector("#enc-output-file-result a")
              .setAttribute("download", "hasil-enkripsi.txt");
          document.querySelector("#enc-output-file-result a")
              .setAttribute("href", "data:text/plain;charset=utf-8,"
                                    + encodeURIComponent(output.as_str));
        } else {
          // TODO
        }
      })();
    };
  </script>
{% endblock %}
